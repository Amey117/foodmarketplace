<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Food Online Payment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <form id="payment-form" style="max-width: 50%;margin: 300px auto;">
        <label for="name">Name:</label><br>
        <input type="text" id="name" name="name"><br>
        <label for="email">Email:</label><br>
        <input type="email" id="email" name="email"><br>
        <div id="payment-element"><!-- Stripe Element will be inserted here --></div>
        <!-- Used to display form errors -->
        <div id="error-message" role="alert"></div><br><br>
        <button id="submit_btn" class="btn btn-primary">Submit Payment</button>
    </form>

    <script>
        var stripe = Stripe('{{ stripe_publishable_key }}');
        const appearance = { /* appearance */ };
        const options = {
        mode: 'payment',
        amount: 177,
        currency: 'inr',
        // Fully customizable with appearance API.
        appearance: {theme: 'stripe'}
        };
        var elements = stripe.elements(options);

       

        var cardElement = elements.create('payment',{
            layout: {
                type: 'accordion',
                defaultCollapsed: false,
                radios: true,
                spacedAccordionItems: false
            }
        });
        cardElement.mount('#payment-element');


        cardElement.addEventListener('change', function(event) {
            var displayError = document.getElementById('error-message');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });


        const submitBtn = document.getElementById('submit_btn');
        var form = document.getElementById('payment-form');

        const handleError = (error) => {
        const messageContainer = document.querySelector('#error-message');
        messageContainer.textContent = error.message;
        submitBtn.disabled = false;
        }

        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            submitBtn.disabled=true
            
            const {error: submitError} = await elements.submit();
            if (submitError) {
                handleError(submitError);
                return;
            }
            const res = await fetch('/orders/intent/create',{
                method:'POST'
            })
            const {client_secret: clientSecret} = await res.json();
            console.log("after await ********",clientSecret)
            const {error} = await stripe.confirmPayment({
                elements,
                clientSecret,
                confirmParams: {
                return_url: 'http://localhost:8000',
                },
            });
            if(error){
                console.log("error occured ..",error)
            }else{
                console.log(" **** payment received successfully...")
            }
            
        });

    </script>
</body>
</html>
